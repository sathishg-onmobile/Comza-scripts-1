select date_format(last_day(curdate()-interval 1 month),'%Y-%m-%d 23:59:59') into @LAST_MONTH;
select date_format((last_day(curdate() - interval 2 month) + interval 1 day),'%Y-%m-%d 00:00:00') into @FIRST_MONTH;
TRUNCATE TABLE subscriber_advance;
insert into subscriber_advance  select market_name,adv_date as advance_datetime,sum(advance_amount_count) as advance_count,sum(advance_amount_sum)as advance_sum from daily_advance_sum where adv_date between @FIRST_MONTH and @LAST_MONTH and market_name<>'tigorw'  group by market_name,date(adv_date);
insert into subscriber_advance select market_name as market_name,adv_date as advance_datetime,sum(advance_amount_count) as advance_count,sum(advance_amount_sum)as advance_sum from daily_advance_sum where adv_date between @FIRST_MONTH and @LAST_MONTH and market_name='tigorw' and advance_amount in('20','84','100','135','150','200','300') group by date(adv_date),market_name;
TRUNCATE TABLE paymnet_based_report;
insert into paymnet_based_report select a.market_name,a.advance_datetime,a.advance_count,a.advance_sum,b.count as same_day_count,b.payment_sum as same_day_payment_sum,c.count as after24hr_count,c.payment_sum as after24hr_payment_sum,d.count as 7days_count,d.payment_sum as 7days_payment_sum,d.advance_sum as 7days_payment from subscriber_advance a,same_day_pay b,1_day_pay c,7days_payments d where a.market_name=b.market_name and c.market_name=a.market_name and d.market_name =a.market_name and a.advance_datetime=b.advance_datetime and c.advance_datetime=a.advance_datetime and d.advance_datetime=a.advance_datetime and  a.advance_datetime between @FIRST_MONTH and @LAST_MONTH group by a.market_name,a.advance_datetime;
drop table final_paymnet_based_report;
create table final_paymnet_based_report as select market_name,advance_datetime,advance_count,advance_sum,same_day_count,same_day_payment_sum,concat(round((same_day_count/advance_count*100),2),'%') as same_day_count_per,concat(round((same_day_payment_sum/advance_sum*100),2),'%') as same_day_sum_per,after24hr_count,after24hr_payment_sum,concat(round((after24hr_count/advance_count*100),2),'%') as after24hr_count_per,concat(round((after24hr_payment_sum/advance_sum*100),2),'%') as after24hr_sum_per,7days_count,7days_payment_sum,concat(round((7days_count/advance_count*100),2),'%') as 7days_count_per,concat(round((7days_payment_sum/advance_sum*100),2),'%') as 7days_sum_per,concat(round((7days_payment/advance_sum*100),2),'%') as 7days_payment from paymnet_based_report;
